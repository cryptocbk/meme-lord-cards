<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meme Lord Cards</title>
  <meta name="description" content="Turn any photo into a shareable Meme Lord card with AI‚Äëgenerated funny quotes. 100% client-side." />
  <meta name="theme-color" content="#0b0f16" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Bangers&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0f16; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#22c55e; --ring:#22c55e55;
      --radius:20px; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 800px at 70% -10%, #1f2937 0%, #0b0f16 40%), var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Apple Color Emoji,Arial,sans-serif;}
    
    /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-50px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(50px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes glow {
      from { text-shadow: 0 0 5px rgba(34, 197, 94, 0.3); }
      to { text-shadow: 0 0 15px rgba(34, 197, 94, 0.6); }
    }
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-8px); }
      60% { transform: translateY(-4px); }
    }
    @keyframes cardFlip {
      0% { transform: rotateY(0deg) scale(1); }
      50% { transform: rotateY(180deg) scale(0.95); }
      100% { transform: rotateY(0deg) scale(1); }
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
      100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }

    header{position:sticky;top:0;backdrop-filter:saturate(1.2) blur(12px);background:linear-gradient(#0b0f16cc,#0b0f1600);z-index:10;animation:fadeInDown 0.8s ease-out;}
    .wrap{max-width:1060px;margin:0 auto;padding:16px}
    .nav{display:flex;align-items:center;gap:12px}
    .logo{font-weight:800;letter-spacing:.5px;animation:glow 2s ease-in-out infinite alternate;}
    .badge{font-size:12px;color:#a7f3d0;background:#064e3b;border:1px solid #065f46;border-radius:999px;padding:4px 8px}

    .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:12px}
    @media(min-width:980px){.grid{grid-template-columns:420px 1fr}}

    .panel{background:linear-gradient(180deg,#141a24,#0f1622);border:1px solid #1f2937;border-radius:var(--radius);padding:14px;box-shadow:var(--shadow);animation:slideInLeft 0.8s ease-out;transition:all 0.3s ease;}
    .panel:hover{transform:translateY(-2px);box-shadow:0 15px 40px rgba(0,0,0,.4);}
    .panel:nth-child(2){animation:slideInRight 0.8s ease-out;}
    .panel:nth-child(3){animation:fadeInUp 0.8s ease-out 0.3s both;}
    .panel h2{margin:0 0 10px 0;font-size:18px}
    .muted{color:var(--muted);font-size:13px}

    .upload{border:2px dashed #374151;border-radius:16px;padding:16px;text-align:center;transition:all .3s ease;position:relative;overflow:hidden;}
    .upload:before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(45deg,transparent,rgba(34,197,94,0.1),transparent);transform:rotate(45deg);transition:all 0.5s;opacity:0;}
    .upload:hover:before{opacity:1;transform:rotate(45deg) translate(50px,50px);}
    .upload.drag{border-color:var(--accent);box-shadow:0 0 0 6px var(--ring);animation:pulse 1s infinite;}
    .upload input{display:none}
    .upload .btn{display:inline-flex;gap:8px;align-items:center;margin-top:10px}

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .field{flex:1;min-width:160px}
    label{display:block;font-size:12px;color:var(--muted);margin:6px 0}
    select,input[type="text"],input[type="number"]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #374151;background:#0b1220;color:var(--text);transition:all 0.3s ease;}
    select:focus,input[type="text"]:focus,input[type="number"]:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--ring);outline:none;}

    .btn{background:#10b981;color:#03211a;border:none;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer;box-shadow:0 6px 16px rgba(16,185,129,.25);transition:all .2s ease;position:relative;overflow:hidden;}
    .btn:before{content:'';position:absolute;top:50%;left:50%;width:0;height:0;background:rgba(255,255,255,0.2);border-radius:50%;transition:all 0.3s;transform:translate(-50%,-50%);}
    .btn:hover:before{width:300px;height:300px;}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(16,185,129,.35);animation:bounce 0.6s ease;}
    .btn:active{transform:translateY(0);}
    .btn.secondary{background:#1f2937;color:#e5e7eb;border:1px solid #374151;box-shadow:none}
    .btn.secondary:hover{background:#374151;box-shadow:0 4px 12px rgba(0,0,0,.3);}
    .btn.ghost{background:transparent;color:var(--text);border:1px dashed #334155}
    .btn.ghost:hover{background:#1f2937;border-color:var(--accent);}

    .tools{display:flex;gap:8px;flex-wrap:wrap}

    canvas{width:100%;max-width:520px;border-radius:16px;border:1px solid #1f2937;background:#0b1220;transition:all 0.3s ease;cursor:pointer;}
    canvas:hover{transform:scale(1.02);box-shadow:0 20px 40px rgba(0,0,0,.4);}
    canvas.flipping{animation:cardFlip 1s ease-in-out;}

    .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
    .thumb{background:#0b1220;border:1px solid #1f2937;border-radius:14px;padding:10px;transition:all 0.3s ease;animation:fadeInUp 0.5s ease-out;}
    .thumb:hover{transform:scale(1.05);box-shadow:0 10px 25px rgba(0,0,0,.3);}
    .thumb img{width:100%;border-radius:10px}

    footer{opacity:.8;font-size:12px;padding:28px 0;text-align:center;animation:fadeInUp 1s ease-out 0.5s both;}
    a{color:#86efac}

    .theme-chip{display:inline-flex;align-items:center;gap:8px;border:1px solid #334155;padding:8px 10px;border-radius:999px;cursor:pointer;transition:all 0.3s ease;}
    .theme-chip:hover{transform:scale(1.05);border-color:#10b981;}
    .theme-chip input{display:none}
    .theme-chip.active{border-color:#10b981;box-shadow:0 0 0 4px var(--ring);animation:pulse 2s infinite;}
    .chips{display:flex;flex-wrap:wrap;gap:10px}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#0b1220;border:1px solid #334155;border-radius:6px;padding:2px 6px;color:#e5e7eb}

    /* –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–µ–∫—Å—Ç–∞ */
    .text-categories{margin:10px 0;display:flex;gap:8px;flex-wrap:wrap;}
    .category-btn{background:#1f2937;color:#e5e7eb;border:1px solid #374151;padding:6px 12px;border-radius:20px;font-size:12px;cursor:pointer;transition:all 0.3s ease;}
    .category-btn:hover{background:#374151;transform:scale(1.05);}
    .category-btn.active{background:var(--accent);color:#03211a;border-color:var(--accent);}
  </style>
</head>
<body>
  <header>
    <div class="wrap nav">
      <div class="logo" style="font-family:Bangers,Inter,sans-serif;font-size:22px;display:flex;align-items:center;gap:10px">
        ü§ñ Meme Lord Cards
      </div>
      <span class="badge">100% client‚Äëside ‚Ä¢ free</span>
    </div>
  </header>

  <main class="wrap grid">
    <!-- LEFT: controls -->
    <section class="panel">
      <h2>1) Upload your photo</h2>
      <div id="drop" class="upload">
        <div>Drag & drop an image here or
          <label for="file" class="btn secondary">choose a file</label>
        </div>
        <div class="muted">JPG/PNG up to ~10 MB. Processed locally in your browser.</div>
        <input id="file" type="file" accept="image/*" />
      </div>

      <h2 style="margin-top:18px">2) Card settings</h2>
      <div class="row">
        <div class="field">
          <label>Display name</label>
          <input id="name" type="text" placeholder="Meme Lord" />
        </div>
        <div class="field">
          <label>Rarity</label>
          <select id="rarity">
            <option>Common</option>
            <option>Rare</option>
            <option>Epic</option>
            <option>Legendary</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Theme</label>
          <div class="chips" id="themes"></div>
        </div>
        <div class="field">
          <label>Funny quote categories</label>
          <div class="text-categories">
            <button class="category-btn active" data-category="funny">üòÇ Funny</button>
            <button class="category-btn" data-category="sarcastic">üòè Sarcastic</button>
            <button class="category-btn" data-category="motivational">üí™ Motivation</button>
            <button class="category-btn" data-category="absurd">ü§™ Absurd</button>
            <button class="category-btn" data-category="tech">üíª Tech</button>
            <button class="category-btn" data-category="life">üåü Life</button>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="field"><label>Meme Level</label><input id="lvl" type="number" min="0" max="999" value="87"/></div>
        <div class="field"><label>Virality %</label><input id="vir" type="number" min="0" max="100" value="69"/></div>
        <div class="field"><label>Chaos</label><input id="chs" type="number" min="0" max="100" value="42"/></div>
      </div>

      <div class="tools" style="margin-top:12px">
        <button id="randomBtn" class="btn" type="button">üé≤ Shuffle stats</button>
        <button id="quoteBtn" class="btn" type="button">‚ú® Smart generate</button>
        <button id="genBtn" class="btn secondary" type="button">‚ö° Render card</button>
        <button id="dlBtn" class="btn secondary" type="button">‚¨áÔ∏è Download PNG</button>
        <button id="shareBtn" class="btn ghost" type="button">üì§ Share</button>
      </div>

      <p class="muted" style="margin-top:10px">Privacy: your image never leaves your device. All rendering happens on the Canvas locally.</p>
    </section>

    <!-- RIGHT: preview -->
    <section class="panel">
      <h2>Preview</h2>
      <canvas id="card" width="750" height="1050" aria-label="Card preview"></canvas>
    </section>

    <section class="panel" style="grid-column:1/-1">
      <h2>Local gallery</h2>
      <div id="gallery" class="gallery"></div>
    </section>
  </main>

  <footer class="wrap">
    Built for fun ‚ù§Ô∏è ‚Äî host this single file on GitHub Pages. No trackers, no servers.
  </footer>

<script>
(function(){
  const $ = (s) => document.querySelector(s);
  const drop = $('#drop');
  const file = $('#file');
  const nameInput = $('#name');
  const rarity = $('#rarity');
  const lvl = $('#lvl');
  const vir = $('#vir');
  const chs = $('#chs');
  const card = $('#card');
  const ctx = card.getContext('2d');
  const dlBtn = $('#dlBtn');
  const genBtn = $('#genBtn');
  const randomBtn = $('#randomBtn');
  const quoteBtn = $('#quoteBtn');
  const shareBtn = $('#shareBtn');
  const gallery = $('#gallery');
  const themesWrap = $('#themes');

  // ---------- THEME DEFINITIONS ----------
  const THEMES = [
    { id:'neon', name:'Neon Vapor', bg:['#0f172a','#0b1220'], glow:'#22d3ee', primary:'#22d3ee', accent:'#f472b6'},
    { id:'gold', name:'Royal Gold', bg:['#1b1b1b','#101010'], glow:'#f59e0b', primary:'#fbbf24', accent:'#fde68a'},
    { id:'matrix', name:'Matrix', bg:['#00140a','#000d08'], glow:'#22c55e', primary:'#10b981', accent:'#34d399'},
    { id:'retro', name:'Retro Pop', bg:['#2b1b47','#1a1030'], glow:'#a78bfa', primary:'#f472b6', accent:'#fb7185'},
    { id:'steel', name:'Steel', bg:['#0a0a0a','#151515'], glow:'#60a5fa', primary:'#93c5fd', accent:'#e5e7eb'}
  ];

  // ---------- IMPROVED TEXT COLLECTION ----------
  const FUNNY_TEXTS = {
    funny: [
      "Powered by caffeine and chaos",
      "Wi‚ÄëFi whisperer, router tamer",
      "Certified 'one more episode' pro",
      "Runs on memes and instant noodles",
      "404: serious face not found",
      "Professional procrastinator since birth",
      "Keyboard warrior, snack champion",
      "Low battery, high drama",
      "Born to scroll, forced to work",
      "Netflix PhD, Amazon Prime member",
      "Adulting level: Still loading...",
      "Sleep is for people without WiFi",
      "Sarcasm is my second language",
      "Currently avoiding responsibilities",
      "Expert in selective hearing",
      "Fluent in movie quotes only",
      "Allergic to mornings and small talk",
      "Professional overthinker & underachiever",
      "Survived on 3 hours sleep & energy drinks",
      "Mastered the art of looking busy"
    ],
    sarcastic: [
      "Oh wow, another life coach",
      "Shocking: Monday exists again",
      "Clearly I peaked in kindergarten",
      "Amazing how that didn't work out",
      "Definitely not overthinking this",
      "Sure, let's make it more complicated",
      "Obviously I have my life together",
      "Fantastic, another meeting about meetings",
      "Perfect timing, as always",
      "Absolutely thrilled about this update",
      "Wonderful, more unsolicited advice",
      "Clearly the expert has arrived",
      "Outstanding work ethic right there",
      "Brilliant plan, nothing could go wrong",
      "Impressive dedication to chaos",
      "Excellent prioritization skills shown",
      "Revolutionary idea: basic common sense",
      "Groundbreaking discovery: water is wet",
      "Shocking revelation: people need coffee",
      "Mind-blowing concept: deadlines exist"
    ],
    motivational: [
      "Believe in your WiFi connection",
      "You're the main character today",
      "Failure is just success in progress",
      "Dream big, start small, act now",
      "Your vibe attracts your tribe",
      "Be the energy you want to attract",
      "Progress over perfection always",
      "Challenges are growth in disguise",
      "Every expert was once a beginner",
      "Your only limit is your mindset",
      "Small steps lead to big changes",
      "Consistency beats perfection",
      "Today's struggle is tomorrow's strength",
      "Growth happens outside comfort zones",
      "You're stronger than your excuses",
      "Success is a series of small wins",
      "Focus on progress, not perfection",
      "Discipline creates freedom",
      "Every day is a fresh start",
      "Your potential is unlimited"
    ],
    absurd: [
      "Professional banana phone operator",
      "Certified unicorn whisperer",
      "Expert in quantum toast physics",
      "Licensed dream architect",
      "Professional cloud taste tester",
      "Certified gravity consultant",
      "Expert in invisible ink calligraphy",
      "Licensed rainbow technician",
      "Professional sock puppet therapist",
      "Certified time sandwich maker",
      "Expert in musical furniture tuning",
      "Licensed dragon parking attendant",
      "Professional bubble wrap philosopher",
      "Certified moon dust sommelier",
      "Expert in backwards water skiing",
      "Licensed penguin dance instructor",
      "Professional cheese mountain climber",
      "Certified invisible rope maker",
      "Expert in upside-down architecture",
      "Licensed flying carpet mechanic"
    ],
    tech: [
      "404: Life motivation not found",
      "Ctrl+Z my last life decision",
      "Running on legacy code and hope",
      "Git commit -m 'fixed everything'",
      "Debugging life one error at a time",
      "Stack Overflow saved my career",
      "printf('Hello World, I'm tired');",
      "Refactoring my life's spaghetti code",
      "Error 418: I'm a teapot",
      "Recursion: see recursion",
      "Null pointer exception in my brain",
      "Compiling... please wait forever",
      "Cache cleared, problems remain",
      "Infinite loop in the breakfast routine",
      "Memory leak detected in my wallet",
      "Deprecated function: early mornings",
      "API request timeout: social skills",
      "Database corrupted: weekend plans",
      "Server down: motivation service",
      "Merge conflict: pizza vs. diet"
    ],
    life: [
      "Plot twist: I'm still figuring it out",
      "Currently buffering life updates",
      "Collecting moments, not things",
      "Living proof that coffee works",
      "Still writing my origin story",
      "Professional human being in training",
      "Mastering the art of winging it",
      "Life's too short for matching socks",
      "Making memories and questionable choices",
      "Currently starring in my own drama",
      "Life coach: my own bad decisions",
      "Expert in learning things the hard way",
      "Specializing in organized chaos",
      "PhD in trial and error methods",
      "Professional day dreamer and night thinker",
      "Certified overthinker with anxiety honors",
      "Master of disguised panic attacks",
      "Advanced practitioner of fake confidence",
      "Distinguished procrastination scholar",
      "Lifetime achievement in missed opportunities"
    ]
  };

  // ---------- STATE ----------
  const state = {
    image: null,
    imageBitmap: null,
    quote: 'Certified Meme Lord',
    theme: THEMES[0],
    currentCategory: 'funny'
  };

  // ---------- UI: THEME CHIPS ----------
  function renderThemeChips(){
    themesWrap.innerHTML = '';
    THEMES.forEach(t => {
      const chip = document.createElement('label');
      chip.className = 'theme-chip' + (state.theme.id===t.id ? ' active' : '');
      chip.innerHTML = `<input type="radio" name="theme" value="${t.id}"><span>üé® ${t.name}</span>`;
      chip.onclick = () => { 
        state.theme = t; 
        drawCard(); 
        document.querySelectorAll('.theme-chip').forEach(c=>c.classList.remove('active')); 
        chip.classList.add('active'); 
      };
      themesWrap.appendChild(chip);
    });
  }
  renderThemeChips();

  // ---------- CATEGORY BUTTONS ----------
  document.querySelectorAll('.category-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      state.currentCategory = this.dataset.category;
    });
  });

  // ---------- IMAGE HANDLING ----------
  function setDropActive(a){ drop.classList.toggle('drag', !!a); }
  ;['dragenter','dragover'].forEach(e=>drop.addEventListener(e, ev=>{ ev.preventDefault(); setDropActive(true); }));
  ;['dragleave','drop'].forEach(e=>drop.addEventListener(e, ev=>{ ev.preventDefault(); setDropActive(false); }));
  drop.addEventListener('drop', async (ev)=>{
    const f = ev.dataTransfer.files?.[0]; if(f) await loadFile(f);
  });
  file.addEventListener('change', async ()=>{ const f = file.files?.[0]; if(f) await loadFile(f); });

  async function loadFile(f){
    if(!f.type.startsWith('image/')) return alert('Please select an image file.');
    state.image = URL.createObjectURL(f);
    state.imageBitmap = await createImageBitmap(await (await fetch(state.image)).blob());
    drawCard();
  }

  // ---------- RANDOMIZATION ----------
  function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function randomize(){
    nameInput.value = ["Meme Lord","Chaos Gremlin","Vibe Captain","Emoji Overlord","Digital Shaman","Pixel Wizard"][rand(0,5)];
    rarity.selectedIndex = rand(0,3);
    lvl.value = rand(10,999); 
    vir.value = rand(1,100); 
    chs.value = rand(0,100);
    // Generate quote from current category
    const categoryTexts = FUNNY_TEXTS[state.currentCategory] || FUNNY_TEXTS.funny;
    state.quote = categoryTexts[rand(0, categoryTexts.length-1)];
    drawCard();
  }

  // ---------- SMART QUOTE GENERATION ----------
  function generateSmartQuote(){
    const categoryTexts = FUNNY_TEXTS[state.currentCategory] || FUNNY_TEXTS.funny;
    state.quote = categoryTexts[rand(0, categoryTexts.length-1)];
    
    // Animation effect
    card.classList.add('flipping');
    setTimeout(() => {
      drawCard();
      card.classList.remove('flipping');
    }, 500);
  }

  // ---------- DRAWING ----------
  function roundRect(ctx, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  function drawBackground(){
    const g = ctx.createLinearGradient(0,0,0,card.height);
    g.addColorStop(0, state.theme.bg[0]);
    g.addColorStop(1, state.theme.bg[1]);
    ctx.fillStyle = g; ctx.fillRect(0,0,card.width,card.height);
    // outer frame
    ctx.strokeStyle = state.theme.primary; ctx.lineWidth = 8; roundRect(ctx, 18, 18, card.width-36, card.height-36, 24); ctx.stroke();
    ctx.shadowColor = state.theme.glow; ctx.shadowBlur = 24; ctx.strokeStyle = state.theme.glow; ctx.lineWidth = 2; roundRect(ctx, 26, 26, card.width-52, card.height-52, 20); ctx.stroke(); ctx.shadowBlur=0;
  }

  function drawImage(){
    const pad = 48; const frameW = card.width - pad*2; const frameH = Math.floor(card.height*0.52);
    const frameX = pad; const frameY = pad + 12;
    // frame bg
    ctx.fillStyle = '#0b1220'; roundRect(ctx, frameX, frameY, frameW, frameH, 18); ctx.fill();
    ctx.strokeStyle = '#334155'; ctx.lineWidth = 3; roundRect(ctx, frameX, frameY, frameW, frameH, 18); ctx.stroke();
    if(!state.imageBitmap) return;
    const img = state.imageBitmap;
    const r = Math.min(frameW/img.width, frameH/img.height);
    const w = img.width*r, h = img.height*r;
    const x = frameX + (frameW - w)/2; const y = frameY + (frameH - h)/2;
    ctx.save(); ctx.beginPath(); roundRect(ctx, frameX+6, frameY+6, frameW-12, frameH-12, 14); ctx.clip();
    ctx.drawImage(img, x, y, w, h); ctx.restore();
  }

  function drawHeader(){
    const title = (nameInput.value || 'Meme Lord').toUpperCase();
    ctx.font = '800 42px Bangers, Inter, sans-serif';
    ctx.fillStyle = '#e5e7eb';
    ctx.textAlign = 'left';
    ctx.fillText(title, 48, 620);

    // rarity pill
    const pill = rarity.value || 'Common';
    const metrics = ctx.measureText(pill);
    const pw = metrics.width + 28; const ph = 36; const px = card.width - pw - 48; const py = 590;
    ctx.fillStyle = '#0b1220'; roundRect(ctx, px, py, pw, ph, 999); ctx.fill();
    ctx.strokeStyle = state.theme.primary; ctx.lineWidth = 2; roundRect(ctx, px, py, pw, ph, 999); ctx.stroke();
    ctx.fillStyle = state.theme.primary; ctx.font = '600 18px Inter, system-ui, sans-serif';
    ctx.textAlign = 'center'; ctx.fillText(pill, px+pw/2, py+24);
  }

  function wrapText(text, x, y, maxWidth, lineHeight){
    const words = text.split(' ');
    let line = '', lines = [], dy = 0;
    
    // Collect all lines first
    for (let n = 0; n < words.length; n++) {
      const testLine = line + words[n] + ' ';
      const metrics = ctx.measureText(testLine);
      if (metrics.width > maxWidth && n > 0) {
        lines.push(line.trim());
        line = words[n] + ' ';
      } else { 
        line = testLine; 
      }
    }
    if(line.trim()) lines.push(line.trim());
    
    // Center vertically and draw
    const totalHeight = lines.length * lineHeight;
    let startY = y - totalHeight/2 + lineHeight/2;
    
    lines.forEach((line, i) => {
      ctx.fillText(line, x, startY + i * lineHeight);
    });
  }

  function drawStats(){
    // quote box - —É–ª—É—á—à–µ–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    const qx = 48, qy = 660, qw = card.width - 96, qh = 120;
    ctx.fillStyle = '#0b1220'; roundRect(ctx, qx, qy, qw, qh, 16); ctx.fill();
    ctx.strokeStyle = '#334155'; ctx.lineWidth = 2; roundRect(ctx, qx, qy, qw, qh, 16); ctx.stroke();

    // –£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ü–∏—Ç–∞—Ç—ã - –∫—Ä—É–ø–Ω–µ–µ –∏ –ø–æ —Ü–µ–Ω—Ç—Ä—É
    ctx.font = '600 24px Inter, system-ui, sans-serif';
    ctx.fillStyle = state.theme.accent;
    ctx.textAlign = 'center';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–≤—ã—á–∫–∏
    const quotedText = `"${state.quote || 'Certified Meme Lord'}"`;
    wrapText(quotedText, qx + qw/2, qy + qh/2, qw - 24, 28);

    // stat bars
    const sx = 48, sy = 810, sw = card.width - 96, sh = 180;
    const stats = [
      {label:'Meme Level', value: +lvl.value||0},
      {label:'Virality', value: +vir.value||0},
      {label:'Chaos', value: +chs.value||0}
    ];
    const barH = 26; let y = sy;
    stats.forEach(st => {
      ctx.font = '600 16px Inter, system-ui, sans-serif';
      ctx.fillStyle = '#cbd5e1'; 
      ctx.textAlign = 'left';
      ctx.fillText(st.label, sx, y+18);
      // track
      const w = sw; const bx = sx; const by = y+24;
      ctx.fillStyle = '#111827'; roundRect(ctx, bx, by, w, barH, 10); ctx.fill();
      ctx.strokeStyle = '#334155'; ctx.lineWidth = 2; roundRect(ctx, bx, by, w, barH, 10); ctx.stroke();
      // fill
      const perc = Math.max(0, Math.min(100, st.value)) / 100;
      const fw = Math.max(8, Math.floor(w*perc));
      const grad = ctx.createLinearGradient(bx, by, bx+fw, by);
      grad.addColorStop(0, state.theme.primary);
      grad.addColorStop(1, state.theme.accent);
      ctx.fillStyle = grad; roundRect(ctx, bx, by, fw, barH, 10); ctx.fill();
      y += 60;
    });

    // footer tag
    ctx.font = '600 14px Inter, system-ui, sans-serif';
    ctx.fillStyle = '#94a3b8';
    ctx.textAlign = 'right';
    ctx.fillText('meme.lord ‚Äì generated offline', card.width-48, card.height-36);
    ctx.textAlign = 'left';
  }

  function drawCard(){
    // clear
    ctx.clearRect(0,0,card.width,card.height);
    drawBackground();
    drawImage();
    drawHeader();
    drawStats();
  }

  // ---------- EXPORT / SHARE ----------
  function toPNG(){ return card.toDataURL('image/png'); }
  dlBtn.addEventListener('click', ()=>{
    const link = document.createElement('a');
    const name = (nameInput.value||'MemeLord').replace(/[^a-z0-9_-]+/gi,'_');
    link.download = `${name}_card.png`;
    link.href = toPNG(); link.click();
    addToGallery();
  });

  async function share(){
    try{
      const blob = await (await fetch(toPNG())).blob();
      const file = new File([blob], 'meme-lord.png', {type:'image/png'});
      if(navigator.canShare && navigator.canShare({files:[file]})){
        await navigator.share({ title:'Meme Lord Card', files:[file], text:'Check my Meme Lord card!' });
      } else {
        alert('Sharing not supported. The image was downloaded instead.');
        dlBtn.click();
      }
    }catch(e){ console.error(e); alert('Share failed. Try downloading instead.'); }
  }
  shareBtn.addEventListener('click', share);

  // ---------- GALLERY ----------
  function addToGallery(){
    const img = new Image(); img.src = toPNG();
    const wrap = document.createElement('div'); wrap.className='thumb';
    const a = document.createElement('a'); a.href = img.src; a.download = 'meme-lord.png';
    a.appendChild(img); wrap.appendChild(a); gallery.prepend(wrap);
  }

  // ---------- EVENTS ----------
  randomBtn.addEventListener('click', randomize);
  quoteBtn.addEventListener('click', generateSmartQuote);
  genBtn.addEventListener('click', drawCard);

  // Click on canvas for flip animation and new quote
  card.addEventListener('click', generateSmartQuote);

  // Auto-generate quotes every 45 seconds for demo
  setInterval(() => {
    if(!state.imageBitmap) {
      generateSmartQuote();
    }
  }, 45000);

  // initial
  drawCard();
})();